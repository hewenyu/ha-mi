# HA-MI: Home Assistant 与小米智能家居桥接服务设计方案

## 1. 项目概述

HA-MI 是一个基于 Go 语言开发的桥接服务，采用类似 VRF 中央控制器的模拟方案，实现小爱同学与 Home Assistant 的互通。项目的主要特点是：

- **无需小爱开发者平台**：不依赖小米开放平台的自定义技能
- **中央控制器模型**：模拟单个或少量虚拟中央设备，简化发现和控制
- **统一命令处理**：基于区域和设备类型的统一命令结构
- **场景和分组控制**：支持复杂的跨设备场景和分组操作
- **易于配置和扩展**：提供 Web 界面进行区域和设备映射管理

## 2. 系统架构

### 2.1 整体架构

```
                         +------------------+
                         |    小爱同学      |
                         +--------+---------+
                                  |
                                  | 单一控制接口
                                  v
+---------------+    +---------------------------+    +-----------------+
| 小米智能家居  | <->| HA-MI 中央控制器虚拟设备  | <->| Home Assistant  |
| 云端         |    |  (统一设备访问接口)       |    | (多种设备实体)   |
+---------------+    +-----------+---------------+    +-----------------+
                                 |
                                 v
                        +----------------+
                        |  Web 管理界面   |
                        +----------------+
```

### 2.2 核心组件

1. **中央控制器层**：
   - 模拟一个或少量小米智能设备作为中央控制器
   - 提供统一的区域和设备控制接口
   - 响应小爱同学的命令并路由到对应实体

2. **设备发现服务**：
   - 实现中央控制器的 mDNS/SSDP 服务发现
   - 注册控制器到小米云端（可选）
   - 保持中央控制器在线状态

3. **命令路由层**：
   - 解析小爱同学控制命令
   - 基于区域和设备类型进行命令路由
   - 将命令映射到 Home Assistant 实体和服务

4. **区域和场景管理**：
   - 管理设备的区域分组
   - 支持复杂场景定义和执行
   - 提供批量控制和联动功能

5. **Web 管理界面**：
   - 区域和设备映射配置
   - 场景和工作流管理
   - 状态监控和命令日志

## 3. 功能详细设计

### 3.1 中央控制器设计

#### 3.1.1 控制器类型

系统将实现以下类型的虚拟中央控制器：

- **智能家居控制中心**：管理灯光、开关、窗帘等基础设备
- **媒体控制中心**：管理电视、音响等媒体设备
- **环境控制中心**：管理空调、温度、湿度等环境设备
- **场景控制中心**：管理预设场景和复杂联动

#### 3.1.2 MIoT 协议实现

- 实现符合 MIoT Spec V2 的中央控制器设备描述
- 为控制器提供必要的服务、属性和操作
- 支持区域化和分组控制的能力定义

#### 3.1.3 区域和设备组织

- 基于 Home Assistant 区域 (areas) 进行设备分组
- 支持自定义区域和设备分类
- 维护区域、设备类型和实体的映射关系

### 3.2 设备发现和认证

#### 3.2.1 控制器发现

- 使用 mDNS/SSDP 广播中央控制器设备
- 提供控制器的设备描述和功能清单
- 确保小爱同学能发现并记住这些控制器

#### 3.2.2 设备身份管理

- 生成并管理控制器的唯一标识和凭证
- 处理与小米云端的认证流程（如需要）
- 维护控制器的在线状态和可用性

### 3.3 命令路由和处理

#### 3.3.1 统一命令结构

命令采用以下统一结构：

```
区域 + 设备类型 + 操作 + 参数
```

例如：
- "客厅 + 灯 + 开"
- "卧室 + 窗帘 + 关"
- "客厅 + 电视 + 输入源 + HDMI1"

#### 3.3.2 命令解析和路由

- 从小爱同学接收控制指令
- 解析出区域、设备类型和操作
- 查找对应的 Home Assistant 实体和服务
- 转换参数并执行控制

#### 3.3.3 Home Assistant 实体映射

```
区域    设备类型    操作     Home Assistant 实体/服务
-------------------------------------------------------
客厅     灯         开/关    light.living_room
卧室     窗帘       开/关    cover.bedroom_curtain
客厅     电视       输入源   media_player.tv_living_room
```

### 3.4 场景和工作流管理

#### 3.4.1 场景定义

场景使用 YAML 或 JSON 格式定义：

```yaml
name: "观影模式"
scene_id: "movie_mode"
actions:
  - zone: "客厅"
    device_type: "灯光"
    operation: "亮度"
    value: 30
  - zone: "客厅"
    device_type: "窗帘"
    operation: "位置"
    value: "closed"
  - delay: 2
  - zone: "客厅"
    device_type: "电视"
    operation: "电源"
    value: "on"
  - delay: 5
  - zone: "客厅"
    device_type: "电视"
    operation: "输入源"
    value: "HDMI1"
```

#### 3.4.2 工作流执行

- 支持小爱同学直接调用场景名称
- 场景控制中心接收并识别场景命令
- 按顺序执行场景中的操作步骤
- 处理并发、条件和错误情况
- 返回场景执行结果

### 3.5 Web 管理界面

#### 3.5.1 区域和设备管理

- 创建和管理区域
- 在区域中添加设备类型和操作
- 将设备映射到 Home Assistant 实体

#### 3.5.2 场景管理

- 图形化场景编辑器
- 场景测试和调试工具
- 场景执行历史和日志

#### 3.5.3 系统配置

- 中央控制器设置
- Home Assistant 连接配置
- 用户账户和权限管理

## 4. 技术选型

### 4.1 后端技术

- **编程语言**：Go 1.23+
- **Web 框架**：Gin 或 Echo
- **数据存储**：BoltDB 或 SQLite
- **网络通信**：标准库 net 包
- **消息队列**：内置通道或 NATS

### 4.2 前端技术

- **框架**：Vue.js 3
- **UI 组件**：Element Plus
- **状态管理**：Pinia

## 5. 实现细节

### 5.1 中央控制器设计实现

基于小米官方 `ha_xiaomi_home` 插件，我们将设计中央控制器的功能：

1. 分析适合作为中央控制器的设备类型
2. 实现符合 MIoT Spec V2 的设备描述
3. 定义控制器支持的服务和操作接口
4. 实现命令接收和响应处理

### 5.2 控制器功能定义

中央控制器需要定义以下功能：

```json
{
  "model": "xiaomi.controller.v1",
  "name": "HA-MI 智能控制中心",
  "services": [
    {
      "siid": 2,
      "type": "urn:miot-spec-v2:service:controller:00007801:xiaomi-ctrl:1",
      "properties": [
        {
          "piid": 1,
          "type": "current_zone",
          "access": ["read", "write", "notify"],
          "values": ["客厅", "卧室", "厨房", "书房"]
        }
      ],
      "actions": [
        {
          "aiid": 1,
          "type": "control_device",
          "in": [
            {
              "piid": 1 
            },
            {
              "piid": 2,
              "type": "device_type"
            },
            {
              "piid": 3,
              "type": "operation"
            },
            {
              "piid": 4,
              "type": "value"
            }
          ]
        },
        {
          "aiid": 2,
          "type": "activate_scene",
          "in": [
            {
              "piid": 5,
              "type": "scene_id"
            }
          ]
        }
      ]
    }
  ]
}
```

### 5.3 命令路由和转换逻辑

命令处理的步骤：

1. 接收来自小爱同学的控制命令
2. 提取区域、设备类型、操作和参数
3. 查询区域-设备-实体映射表
4. 找到对应的 Home Assistant 实体和服务
5. 转换参数格式（如数值映射、单位转换）
6. 通过 Home Assistant API 执行控制
7. 收集执行结果并返回给小爱同学

### 5.4 区域和设备映射表

以 JSON 格式定义映射关系：

```json
{
  "zones": {
    "客厅": {
      "devices": {
        "灯": {
          "operations": {
            "开": {
              "entity": "light.living_room",
              "service": "light.turn_on",
              "params": {}
            },
            "关": {
              "entity": "light.living_room",
              "service": "light.turn_off",
              "params": {}
            },
            "亮度": {
              "entity": "light.living_room",
              "service": "light.turn_on",
              "params": {
                "brightness": "{value}"
              },
              "value_mapping": {
                "type": "percentage_to_brightness"
              }
            }
          }
        },
        "电视": {
          "operations": {
            "开": {
              "entity": "media_player.living_room_tv",
              "service": "media_player.turn_on"
            },
            "关": {
              "entity": "media_player.living_room_tv",
              "service": "media_player.turn_off"
            },
            "输入源": {
              "entity": "media_player.living_room_tv",
              "service": "media_player.select_source",
              "params": {
                "source": "{value}"
              }
            }
          }
        }
      }
    }
  }
}
```

## 6. 部署方案

### 6.1 独立部署

- 编译为独立二进制文件
- 支持 systemd 服务管理
- 提供 Docker 容器部署选项
- 网络配置（需要与小爱同学在同一局域网）

### 6.2 Home Assistant 插件形式

- 开发为 Home Assistant 插件
- 自动配置与 HA 的连接
- 利用 HA 提供的网络环境

## 7. 开发路线图

### 7.1 第一阶段（基础功能）

- 中央控制器设计和实现
- 基础命令路由和执行
- 简单区域和设备类型支持
- Home Assistant API 调用

### 7.2 第二阶段（功能完善）

- 完整区域和设备类型支持
- 场景定义和执行
- Web 管理界面开发
- 参数转换和映射功能

### 7.3 第三阶段（优化和扩展）

- 性能优化和稳定性提升
- 高级场景和条件控制
- 语音命令模式识别改进
- 状态同步和反馈机制

## 8. 示例场景

### 8.1 基础设备控制

用户说："小爱同学，打开客厅的灯"

系统处理流程：
1. 小爱同学将命令发送给中央控制器
2. 控制器解析命令，识别区域为"客厅"，设备为"灯"，操作为"打开"
3. 查找映射表，找到对应的 Home Assistant 实体和服务
4. 执行 `light.turn_on` 服务，控制 `light.living_room` 实体
5. 将执行结果返回给小爱同学
6. 小爱同学播报："好的，已为您打开客厅的灯"

### 8.2 复杂场景控制

用户说："小爱同学，打开观影模式"

系统处理流程：
1. 小爱同学将命令发送给场景控制中心
2. 控制器识别这是场景命令，查找"观影模式"场景定义
3. 按顺序执行场景中的操作：
   - 调暗客厅灯光
   - 关闭客厅窗帘
   - 打开客厅电视
   - 等待 5 秒（电视启动时间）
   - 将电视输入源切换到 HDMI1
4. 将执行结果返回给小爱同学
5. 小爱同学播报："好的，观影模式已启动"

### 8.3 参数化控制

用户说："小爱同学，把客厅灯调到 50% 亮度"

系统处理流程：
1. 小爱同学将命令发送给中央控制器
2. 控制器解析命令，识别区域为"客厅"，设备为"灯"，操作为"亮度"，参数为"50%"
3. 查找映射表，找到对应的实体和服务
4. 执行参数转换，将 50% 转换为 Home Assistant 亮度值（0-255）
5. 执行 `light.turn_on` 服务，设置亮度参数
6. 返回执行结果

## 9. 安全考虑

- 局域网安全：限制控制器的访问控制
- 命令验证：验证命令来源和合法性
- 敏感操作保护：对重要操作增加确认机制
- 日志审计：记录所有设备操作和场景执行

## 10. 挑战与解决方案

### 10.1 潜在挑战

1. **中央控制器功能设计**：
   - 解决方案：选择支持丰富功能集的小米设备类型作为模板，自定义必要的服务和操作

2. **命令解析复杂性**：
   - 解决方案：实现区域、设备类型和操作的标准化命名，建立完善的映射关系

3. **场景执行稳定性**：
   - 解决方案：实现步骤执行状态追踪，支持失败重试和恢复机制

4. **语音命令多样性**：
   - 解决方案：支持同一操作的多种表述方式，实现命令别名和模糊匹配

### 10.2 优势

1. **简化架构**：单一或少量中央控制器，减少设备发现和管理复杂性
2. **自然交互**：支持更符合自然语言习惯的命令结构
3. **易于扩展**：添加新设备只需更新映射表，无需修改核心逻辑
4. **强大的场景能力**：支持复杂的多设备联动和条件控制
5. **无需小爱开发者资源**：保持使用原生小爱语音控制的便捷性 